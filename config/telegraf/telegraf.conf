# Global tags - can be overridden by environment variables
[global_tags]
  environment = "${TELEGRAF_ENV:-production}"
  project = "hydroponic_monitor"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  logfile = ""
  omit_hostname = false

# MQTT -> Sensors
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  # Authentication (commented out for integration testing with anonymous access)
  # username = "$MQTT_USER"
  # password = "$MQTT_PASS"
  topics = ["grow/tent/+/sensor/+/+/state"]
  qos = 0
  persistent_session = false
  client_id = "telegraf-grow-sensors"
  connection_timeout = "30s"
  data_format = "json"
  name_override = "env"

# MQTT -> Actuator State
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  # Authentication (commented out for integration testing with anonymous access)
  # username = "$MQTT_USER"
  # password = "$MQTT_PASS"
  topics = ["grow/tent/+/actuator/+/+/state"]
  qos = 1
  persistent_session = false
  client_id = "telegraf-grow-actuators"
  connection_timeout = "30s"
  data_format = "json"
  name_override = "actuator_state"

# MQTT -> Node Status
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  # Authentication (commented out for integration testing with anonymous access)
  # username = "$MQTT_USER"
  # password = "$MQTT_PASS"
  topics = ["grow/tent/+/status"]
  qos = 1
  client_id = "telegraf-grow-status"
  data_format = "value"
  data_type = "string"
  name_override = "node_status"
  connection_timeout = "30s"

# Production: Sensors -> grow_raw
[[outputs.influxdb_v2]]
  urls = ["$INFLUX_URL"]
  token = "$INFLUX_TOKEN"
  organization = "$INFLUX_ORG"
  bucket = "grow_raw"
  namepass = ["env"]
  [outputs.influxdb_v2.tagdrop]
    environment = ["integration_test"]

# Production: Actuator state + node status -> grow_state
[[outputs.influxdb_v2]]
  urls = ["$INFLUX_URL"]
  token = "$INFLUX_TOKEN"
  organization = "$INFLUX_ORG"
  bucket = "grow_state"
  namepass = ["actuator_state","node_status"]
  [outputs.influxdb_v2.tagdrop]
    environment = ["integration_test"]

# Test: All data -> single test bucket
[[outputs.influxdb_v2]]
  urls = ["$INFLUX_URL"]
  token = "$INFLUX_TOKEN"
  organization = "$INFLUX_ORG"
  bucket = "test-bucket"
  [outputs.influxdb_v2.tagpass]
    environment = ["integration_test"]