# Global tags - can be overridden by environment variables
[global_tags]
  environment = "${TELEGRAF_ENV:-production}"
  project = "hydroponic_monitor"

[agent]
  interval = "1s"
  round_interval = true
  metric_batch_size = 1
  metric_buffer_limit = 1000
  collection_jitter = "0s"
  flush_interval = "1s"
  flush_jitter = "0s"
  logfile = ""
  omit_hostname = false

# MQTT -> Sensors
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  # Authentication (commented out for integration testing with anonymous access)
  # username = "$MQTT_USER"
  # password = "$MQTT_PASS"
  topics = ["grow/tent/+/sensor/+/+/state"]
  qos = 0
  persistent_session = false
  client_id = "telegraf-grow-sensors"
  connection_timeout = "15s"
  data_format = "json"
  name_override = "env"
  
  # Add topic parsing for tags
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "grow/tent/+/sensor/+/+/state"
    measurement = "_"
    tags = "node/measurement/sensor_type/sensor_id/_"
  
  # Convert JSON fields to proper tags and fields
  tag_keys = ["unit", "id"]
  json_string_fields = ["ts"]

# MQTT -> Actuator State
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  # Authentication (commented out for integration testing with anonymous access)
  # username = "$MQTT_USER"
  # password = "$MQTT_PASS"
  topics = ["grow/tent/+/actuator/+/+/state"]
  qos = 1
  persistent_session = true
  client_id = "telegraf-grow-actuators"
  connection_timeout = "15s"
  data_format = "json"
  name_override = "actuator_state"
  
  # Add topic parsing for actuator tags
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "grow/tent/+/actuator/+/+/state"
    measurement = "_"
    tags = "node/measurement/device_type/device_id/_"

# MQTT -> Node Status
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  # Authentication (commented out for integration testing with anonymous access)
  # username = "$MQTT_USER"
  # password = "$MQTT_PASS"
  topics = ["grow/tent/+/status"]
  qos = 1
  persistent_session = true
  client_id = "telegraf-grow-status"
  data_format = "value"
  data_type = "string"
  name_override = "node_status"
  connection_timeout = "15s"
  
  # Convert string status to numeric value
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "grow/tent/+/status"
    measurement = "_"
    tags = "node/_"

# String processing for node status
[[processors.strings]]
  namepass = ["node_status"]
  [[processors.strings.replace]]
    measurement = "*"
    old = "ONLINE"
    new = "1"
  [[processors.strings.replace]]
    measurement = "*"
    old = "OFFLINE"
    new = "0"

# Convert node status to numeric field
[[processors.converter]]
  namepass = ["node_status"]
  [processors.converter.fields]
    integer = ["value"]
  [processors.converter.tags]
    string = []

# Rename value field to online for node status
[[processors.rename]]
  namepass = ["node_status"]
  [[processors.rename.replace]]
    field = "value"
    dest = "online"

# Production: Sensors -> grow_raw
[[outputs.influxdb_v2]]
  urls = ["$INFLUX_URL"]
  token = "$INFLUX_TOKEN"
  organization = "$INFLUX_ORG"
  bucket = "grow_raw"
  namepass = ["env"]
  [outputs.influxdb_v2.tagdrop]
    environment = ["integration_test"]

# Production: Actuator state + node status -> grow_state
[[outputs.influxdb_v2]]
  urls = ["$INFLUX_URL"]
  token = "$INFLUX_TOKEN"
  organization = "$INFLUX_ORG"
  bucket = "grow_state"
  namepass = ["actuator_state","node_status"]
  [outputs.influxdb_v2.tagdrop]
    environment = ["integration_test"]

# Test: All data -> single test bucket
[[outputs.influxdb_v2]]
  urls = ["$INFLUX_URL"]
  token = "$INFLUX_TOKEN"
  organization = "$INFLUX_ORG"
  bucket = "test-bucket"
  [outputs.influxdb_v2.tagpass]
    environment = ["integration_test"]