services:
  # InfluxDB for time-series data storage
  influxdb:
    image: influxdb:2.7
    container_name: hydroponic_test_influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=password123
      - DOCKER_INFLUXDB_INIT_ORG=test-org
      - DOCKER_INFLUXDB_INIT_BUCKET=test-bucket
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=test-token-for-integration-tests
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
      - ../../config/influxdb/init-buckets.sh:/docker-entrypoint-initdb.d/init-buckets.sh:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # MQTT broker (Mosquitto) - Test mode with anonymous access for backward compatibility
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: hydroponic_test_mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      # mosquitto_data:/mosquitto/data
      #- mosquitto_logs:/mosquitto/log
      - ../../config/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    healthcheck:
      test: ["CMD", "mosquitto_pub", "-h", "localhost", "-t", "health", "-m", "check"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Telegraf for data collection and forwarding
  telegraf:
    image: telegraf:1.30-alpine
    container_name: hydroponic_test_telegraf
    depends_on:
      influxdb:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    volumes:
      - ../../config/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    environment:
      TELEGRAF_ENV: integration_test
      INFLUX_URL: http://influxdb:8086
      INFLUX_TOKEN: test-token-for-integration-tests
      INFLUX_ORG: test-org
    healthcheck:
      test: ["CMD", "telegraf", "--config", "/etc/telegraf/telegraf.conf", "--test"]
      interval: 60s
      timeout: 30s
      retries: 3
    restart: unless-stopped

  # Nginx reverse proxy to unify access (test environment)
  nginx:
    image: nginx:1.27-alpine
    container_name: hydroponic_test_nginx
    depends_on:
      influxdb:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    ports:
      - "8081:80"   # Use 8081 here to avoid clashing with root compose proxy (8080)
    volumes:
      - ../../config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

volumes:
  influxdb_data:
    driver: local
  influxdb_config:
    driver: local
  mosquitto_data:
    driver: local
  mosquitto_logs:
    driver: local